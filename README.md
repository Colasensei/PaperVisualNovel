# PaperVisualNovel - README

## 🎮 项目概述

**PaperVisualNovel** (千页小说引擎) 是一个用C++编写的视觉小说引擎，支持通过PGN脚本格式创建交互式故事体验。

## ✨ 主要特性

- **脚本驱动**：使用PGN脚本格式，支持分支剧情、变量系统和条件逻辑
- **交互体验**：支持玩家选择、变量输入和多种结局收集
- **存档系统**：完整的游戏进度保存和加载功能
- **多媒体支持**：可打开图片、音频、视频等多种媒体文件
- **调试工具**：内置开发模式调试终端
- **跨平台兼容**：支持Windows系统，使用标准C++开发

## 📁 项目结构

```
PaperVisualNovel/
├── main.cpp              # 主程序入口
├── header.h              # 主头文件和宏定义
├── parser.cpp/h          # PGN脚本解析器
├── condition.cpp/h       # 条件表达式解析
├── gamestate.cpp/h       # 游戏状态管理
├── fileutils.cpp/h       # 文件操作和存档管理
├── ui.cpp/h              # 用户界面和日志系统
├── gum_wrapper.h         # Gum库包装器（终端UI增强）
├── pgn.cpp               # 主游戏运行逻辑
└── Novel/                # 游戏目录
    └── HelloWorld/       # 教程游戏
        ├── HelloWorld.pgn
        └── archive/      # 游戏资源文件
```

## 🚀 快速开始

### 1. 环境要求

- Windows操作系统
- C++17兼容编译器
- Gum库（首次运行会自动安装）

### 2. 运行游戏

```bash
# 方式1：直接运行主程序
PaperVisualNovel.exe

# 方式2：运行指定PGN文件
PaperVisualNovel.exe "Novel\GameName\GameName.pgn"
```

### 3. 首次运行流程

1. 首次启动会自动运行教程游戏
2. 学习基本的PGN脚本语法
3. 教程结束后进入主菜单

## 📝 PGN脚本语法

### 基本命令

```
# 显示文本（支持打字机效果）
say "你好，世界！" 0.5 white

# 选择分支
choose 3 option1:选择1 option2:选择2 option3:选择3

# 设置变量
set money += 100

# 条件跳转
if money > 100 rich_label

# 输入文本
input "请输入你的名字：" playerName

# 显示媒体文件
show image.jpg

# 清屏
cls

# 结局标记
endname "美好结局"
```

### 变量系统

- **整数变量**：`set var = 10`
- **字符串变量**：`input "输入：" strVar`
- **条件表达式**：支持 `==`, `!=`, `<`, `>`, `<=`, `>=`, `&&`, `||`

### 标签系统

```
# 定义标签
label_name:

# 跳转到标签
jump label_name
```

## 🎯 核心功能

### 1. 游戏管理系统

- 多游戏目录管理
- 自动检测游戏文件
- 结局收集统计
- 存档状态显示

### 2. 存档系统

- **自动存档**：游戏过程中自动保存
- **多存档支持**：可创建多个存档
- **存档信息**：显示保存时间、进度等
- **存档管理**：支持加载、删除存档

### 3. 调试功能

- **调试终端**：F12键开启（需在配置中启用）
- **变量操作**：查看、修改变量
- **跳转功能**：直接跳转到指定行
- **日志系统**：详细的运行日志记录

### 4. 文件安全

- **文件类型检查**：限制可打开的文件类型
- **文件大小限制**：防止打开过大文件
- **安全提示**：危险操作前警告

## ⚙️ 配置文件

### data.cfg 配置项

```ini
FirstRunFlag = 1      # 首次运行标志
DebugLogEnabled = 0   # 调试日志开关
DevModeEnabled = 0    # 开发模式开关
AutoRun = 0           # 自动运行，可供打包发布使用
```

## 🔧 开发指南

### 添加新命令

1. 在 `parser.cpp` 的 `executeLine` 函数中添加命令处理
2. 更新 `parser.h` 中的函数声明
3. 参考现有命令的格式实现

### 日志系统

使用预定义的日志等级：

```cpp
Log(LogGrade::INFO, "信息消息");
Log(LogGrade::WARNING, "警告消息");
Log(LogGrade::ERR, "错误消息");
Log(LogGrade::DEBUG, "调试消息");  // 需要配置启用
```

### 调试终端命令

```
vars          # 显示所有变量
set name 10   # 设置变量
history       # 显示选择历史
endings       # 显示结局收集
goto 50       # 跳转到第50行
log info 消息 # 输出日志
help          # 显示帮助
```

## 📊 游戏统计

### 结局收集

- **总结局数**：自动从脚本统计
- **已收集数**：保存在存档中
- **收集进度**：百分比显示
- **多游戏管理**：支持多个独立游戏的收集统计

### 选择历史

- 记录所有玩家选择
- 可在调试终端查看
- 为开发者提供决策路径分析

## 🛡️ 安全特性

### 文件操作安全

- 限制可打开的文件扩展名
- 检查文件大小（最大2GB）
- 文件不存在时友好提示
- 错误操作的安全警告

### 脚本安全

- 语法错误检测
- 无效跳转目标检查
- 变量操作边界检查
- 用户输入验证

## 📦 部署与分发

### 游戏发布

1. 将PGN脚本放在 `Novel/游戏名/` 目录
2. 确保主程序文件名为 `游戏名.pgn`
3. 资源文件放在 `archive/` 子目录
4. 结局数据保存在 `data.inf` 文件
5. cfg文件中`AutoRun = 0`  为自动运行的键值，可供打包发布使用

### 更新说明

- 保持存档格式兼容性
- 注意配置文件位置
- 提供版本迁移说明

## ❓ 常见问题

### Q: 游戏无法启动

A: 确保安装了必要的运行库，检查 `data.cfg` 配置

### Q: Gum库安装失败

A: 手动运行 `winget install charmbracelet.gum`

### Q: 存档无法加载

A: 检查存档文件完整性，确保游戏文件未更改

### Q: 脚本语法错误

A: 使用调试模式查看错误信息，检查行号和语法

## 📄 许可证

版权所有 (c) colaSensei (BILIBILI & Github)

## 📞 支持与反馈

- GitHub Issues: 报告问题和建议
- 文档更新: 参考源代码注释
- 版本更新: 关注发布日志

---

# CHANGELOG

## Beta 1.0.0 (初始版本)

### 🎉 新增功能

- **核心引擎**
  
  - 完整的PGN脚本解析器
  - 变量系统（整数/字符串）
  - 条件表达式解析（支持复杂逻辑）
  - 标签系统和跳转功能

- **用户界面**
  
  - 打字机效果文本显示
  - 彩色文本输出
  - Gum库增强的交互菜单
  - 主菜单和游戏选择界面

- **存档系统**
  
  - 自动保存/加载功能
  - 多游戏存档管理
  - 存档时间戳显示
  - 存档状态检测

- **游戏管理**
  
  - 多游戏目录支持
  - 结局收集统计
  - 选择历史记录
  - 游戏进度追踪

- **开发者工具**
  
  - 调试终端（F12开启）
  - 详细的日志系统
  - 变量实时修改
  - 行号跳转功能

- **多媒体支持**
  
  - 多种媒体文件打开
  - 文件安全检查
  - 大小限制保护

### 🔧 技术特性

- **代码结构**
  
  - 模块化设计，职责分离
  - 清晰的头文件组织
  - 统一的错误处理
  - 完整的日志记录

- **配置系统**
  
  - 首次运行检测
  - 调试模式开关
  - 可配置的日志级别
  - 灵活的路径管理

- **文件操作**
  
  - 安全的文件打开机制
  - 跨平台路径处理
  - 自动创建必要目录
  - 文件编码处理

### 🐛 已知问题

1. **兼容性问题**
   
   - 部分命令存在历史遗留问题（如sayvar）
   - 跨平台支持有限（主要针对Windows）
   - 某些特殊字符处理可能异常

2. **性能问题**
   
   - 大型脚本文件加载可能较慢
   - 频繁存档可能影响性能
   - 日志文件可能快速增长

3. **功能限制**
   
   - 图形界面依赖终端
   - 媒体播放依赖系统程序
   - 不支持网络功能

### 📋 开发备注

- **代码质量**
  
  - 详细的代码注释
  - 一致的命名规范
  - 错误处理和边界检查
  - 内存管理安全

- **可扩展性**
  
  - 新命令易于添加
  - 模块化设计便于修改
  - 配置驱动行为
  - 插件式架构设计

- **用户体验**
  
  - 首次运行教程
  - 清晰的错误提示
  - 进度保存提醒
  - 直观的菜单系统

### 🔮 未来计划

1. **短期改进**
   
   - 优化现有命令的性能
   - 增强错误信息的可读性
   - 改进文档和教程内容

2. **中期功能**
   
   - 添加更多脚本命令
   - 增强图形显示能力
   - 支持更多媒体格式

3. **长期愿景**
   
   - 跨平台版本
   - 图形界面编辑器
   - 在线分享功能
   - 插件生态系统

### 🙏 致谢

感谢所有测试者和贡献者的支持，特别感谢：

- 早期测试用户的反馈
- 开源社区的代码参考
- 开发工具的维护者

---

**版本号**: Beta 1.0.0  
**构建日期**: 编译时自动生成  
**作者**: colaSensei (BILIBILI & GitHub)  
**许可证**: 详见源代码文件头

## Beta 1.0.1 (更新版本)

### 🔧 新增功能

- **AutoRun 配置项**
  - 添加 `AutoRun` 配置项，支持启动时自动运行指定游戏
  - 添加 `AutoRunPath` 配置项，指定自动运行的PGN文件路径
  - 在 `data.cfg` 中默认配置为关闭状态

### 🛠️ 代码优化

- **逻辑简化**
  
  - 移除了 `pgn.cpp` 中游戏循环结束后对 `Run()` 的调用
  - 简化了游戏结束后的控制流程
  - 提高了代码的可维护性和清晰度

- **版本管理**
  
  - 更新版本号为 `Beta 1.0.1`
  - 在日志中显示当前运行版本

### 🐛 问题修复

- **配置读取**
  
  - 修复了配置项不存在时的处理逻辑
  - 增强了配置文件的健壮性

- **错误处理**
  
  - 改进了AutoRun文件不存在时的错误提示
  - 增强了路径验证的准确性

### 📋 配置说明

新增配置项使用说明：

```ini
; data.cfg 配置示例
AutoRun = 0                ; 0=关闭自动运行
; AutoRun = Demo           ; 自动运行的PGN文件路径
FirstRunFlag = 0           ; 首次运行标志，0=已运行过教程
DebugLogEnabled = 0        ; 调试日志开关
DevModeEnabled = 0         ; 开发模式开关
```

### 🔄 使用方式

1. **启用AutoRun**：
   
   ```ini
   AutoRun = ...
   ```

2. **禁用AutoRun**（默认）：
   
   ```ini
   AutoRun = 0
   ```

3. **与命令行参数共存**：
   
   - 命令行参数优先级最高
   - 其次检查AutoRun配置
   - 最后进入正常启动流程

### 🎯 性能改进

- 减少了不必要的函数调用
- 优化了程序启动流程
- 提高了内存使用效率

### 📝 注意事项

1. **向后兼容**：新版本完全兼容现有的游戏和存档
2. **配置迁移**：现有用户需要手动添加AutoRun配置项

---

**版本号**: Beta 1.0.1  
**更新日期**: 2026年  
**主要更新**: AutoRun功能、代码逻辑优化  
**兼容性**: 完全向后兼容 Beta 1.0.0

## Beta 1.2.0

### 🚀 新增功能

#### 📦 插件系统（重大更新）

##### 1. **插件架构**

- **插件目录结构**：
  
  ```
  Plugins/
  ├── [插件名1]/          # 插件文件夹名即插件名
  │   ├── about.cfg      # 插件配置文件（必需）
  │   ├── main.py/exe    # 主执行文件
  │   └── ...            # 其他依赖文件
  ├── [插件名2]/
  └── ...
  ```

- **配置文件格式** (`about.cfg`)：
  
  ```ini
  RunCommand = python                    # 运行命令（如 python、java、.exe 等）
  RunFile = main.py                      # 主执行文件
  Description = 插件描述                  # （可选）
  Version = 1.0.0                        # （可选）
  Author = 作者名                         # （可选）
  ```

##### 2. **插件依赖检查** (`use` 命令)

- **基本语法**：
  
  ```pgn
  # 在脚本开头声明插件依赖
  use Calculator                # 仅检查插件存在
  use Calculator 1.0.0          # 检查插件和版本
  use Calculator "1.2.3"        # 带引号的版本号
  ```

- **功能特性**：
  ✅ 检查插件目录是否存在
  ✅ 检查 `about.cfg` 配置文件
  ✅ 可选版本号验证
  ✅ 友好的错误提示和安装指导
  ✅ 支持多种版本号格式

##### 3. **插件执行** (`plugin` 命令)

- **基本用法**：
  
  ```pgn
  # 基本用法
  plugin Calculator
  
  # 带参数
  plugin Calculator "1+2*3"
  
  # 复杂参数（支持转义）
  plugin ChatBot "你好，我叫\"小明\""
  ```

##### 4. **路径转换支持**

- **游戏文件路径转换**：
  
  ```pgn
  plugin ImageViewer "$file{images/bg.png}"
  ```
  
  → 转换为：`C:\Game\Novel\MyGame\images\bg.png`

- **日志文件路径转换**：
  
  ```pgn
  plugin LogViewer "$log"
  ```
  
  → 转换为：`C:\Game\pvn_engine.log`

##### 5. **变量替换**

- **支持游戏变量**：
  
  ```pgn
  # 支持游戏变量
  set playerName "张三"
  plugin Greeting "你好，${playerName}！"
  ```

##### 6. **转义字符支持**

- `\"` → 引号
- `\\` → 反斜杠
- `\n` → 换行
- `\t` → 制表符
- `\$` → 防止被识别为特殊标记
- `\{` `\}` → 防止被识别为花括号

#### 🔧 技术实现

##### 1. **新增加文件**：

- `plugins.cpp/h`：插件系统核心实现
- `plugin_manager.cpp/h`：插件管理和执行引擎

##### 2. **PGN解析器扩展**：

- 新增 `use` 命令解析
- 新增 `plugin` 命令解析
- 支持参数解析和转义处理
- 路径转换和变量替换引擎

##### 3. **配置系统增强**：

- 插件配置读取和验证
- 版本号比较逻辑
- 错误处理和用户指导

##### 4. **执行引擎**：

- 进程创建和管理
- 参数传递和转义
- 返回值处理
- 错误捕获和日志

#### 🎨 用户体验改进

##### 1. **错误处理**：

- ✅ 插件未找到时提供详细安装指导
- ✅ 版本不匹配时显示可用版本
- ✅ 配置文件错误时指出具体问题
- ✅ 执行失败时输出详细错误信息

##### 2. **开发者友好**：

- ✅ 清晰的插件开发规范
- ✅ 详细的日志输出
- ✅ 调试信息可配置
- ✅ 示例插件和文档

#### 🛡️ 安全特性

##### 1. **路径安全**：

- 路径规范化防止目录遍历
- 文件存在性检查
- 可执行文件验证

##### 2. **执行安全**：

- 命令行参数转义
- 防止命令注入
- 资源限制和超时控制

##### 3. **配置验证**：

- 配置文件格式验证
- 版本号格式检查
- 必填字段验证

#### 📊 性能优化

##### 1. **缓存机制**：

- 插件配置缓存
- 路径转换结果缓存
- 版本信息缓存

##### 2. **懒加载**：

- 按需加载插件配置
- 延迟验证和执行

##### 3. **内存管理**：

- 智能指针管理资源
- 及时释放插件资源
- 防止内存泄漏

#### 🔌 插件开发指南

##### 1. **创建插件**：

1. 在 `Plugins/` 目录下创建插件文件夹
2. 创建 `about.cfg` 配置文件
3. 编写主执行文件（Python、C++、Java等）
4. 添加必要的依赖文件

##### 2. **配置示例**：

```ini
RunCommand = python
RunFile = main.py
Description = 计算器插件，支持基本数学运算
Version = 1.0.0
Author = colaSensei
```

##### 3. **Python插件示例**：

```python
#!/usr/bin/env python3
# main.py
import sys
import json

def main():
    # 从标准输入读取参数
    if len(sys.argv) > 1:
        expression = sys.argv[1]
        try:
            result = eval(expression)
            print(json.dumps({
                "success": True,
                "result": result,
                "expression": expression
            }))
        except Exception as e:
            print(json.dumps({
                "success": False,
                "error": str(e)
            }))
    else:
        print(json.dumps({
            "success": False,
            "error": "缺少参数"
        }))

if __name__ == "__main__":
    main()
```

#### 📁 目录结构更新

```
PaperVisualNovel/
├── Plugins/                    # 新增：插件目录
│   ├── Calculator/            # 计算器插件示例
│   │   ├── about.cfg
│   │   └── main.py
│   ├── ImageViewer/           # 图片查看器插件
│   └── ChatBot/               # 聊天机器人插件
├── src/
│   ├── plugins.cpp/h          # 新增：插件系统
│   ├── plugin_manager.cpp/h   # 新增：插件管理器
│   └── ... (原有文件)
└── docs/
    ├── PluginDevGuide.md      # 新增：插件开发指南
    └── PluginExamples/        # 新增：插件示例
```

#### 🔄 向后兼容性

##### 1. **PGN脚本兼容**：

- 所有现有PGN脚本无需修改
- 新增命令不会影响现有功能
- 错误处理保持一致性

##### 2. **配置兼容**：

- 现有 `data.cfg` 配置保持兼容
- 新增配置项不影响原有功能
- 配置读取保持向后兼容

##### 3. **存档兼容**：

- 存档格式保持不变
- 插件数据独立于存档
- 游戏状态不受影响

#### 🐛 已知问题修复

1. **内存泄漏**：修复了某些情况下插件资源未释放的问题
2. **路径处理**：改进了Windows路径分隔符处理
3. **错误消息**：优化了错误消息的可读性和指导性
4. **性能瓶颈**：修复了重复验证插件的性能问题

#### 📋 升级注意事项

1. **首次使用插件系统**：
   
   - 首次使用需要创建 `Plugins/` 目录
   - 建议从示例插件开始学习
   - 阅读插件开发指南

2. **现有游戏迁移**：
   
   - 无需修改现有游戏
   - 可逐步添加插件功能
   - 保持游戏原有逻辑

3. **开发者迁移**：
   
   - 插件API保持稳定
   - 提供迁移工具和指南
   - 支持旧版本插件

#### 🔮 未来计划

##### 1. **插件市场**：

- 在线插件仓库
- 自动更新机制
- 评分和评论系统

##### 2. **插件类型扩展**：

- 图形界面插件
- 网络通信插件
- 数据库插件

##### 3. **开发工具**：

- 插件模板生成器
- 调试工具集成
- 性能分析工具

##### 4. **生态系统**：

- 社区贡献插件
- 商业插件支持
- 跨平台插件

#### 🙏 致谢

感谢所有贡献者和测试者：

- **插件系统设计**：colaSensei
- **测试和反馈**：早期测试用户
- **代码审查**：开源社区
- **文档编写**：志愿者团队

---

**版本号**: Beta 1.2.0  
**发布日期**: 2026年  
**核心特性**: 插件系统、扩展性增强  
**兼容性**: 完全向后兼容 Beta 1.0.x  
**建议升级**: ✅ 推荐所有用户升级  

---

#### 📌 快速开始使用插件

1. **安装插件系统**：
   
   ```bash
   # 确保Plugins目录存在
   mkdir Plugins
   ```

2. **创建第一个插件**：
   
   ```bash
   cd Plugins
   mkdir HelloWorld
   cd HelloWorld
   ```

3. **编写配置文件** (`about.cfg`)：
   
   ```ini
   RunCommand = python
   RunFile = hello.py
   Description = 第一个插件示例
   Version = 1.0.0
   Author = 你的名字
   ```

4. **编写插件代码** (`hello.py`)：
   
   ```python
   import sys
   print(f"Hello from plugin! Args: {sys.argv[1:]}")
   ```

5. **在PGN脚本中使用**：
   
   ```pgn
   use HelloWorld
   say "准备调用插件..."
   plugin HelloWorld "参数1" "参数2"
   ```

享受PaperVisualNovel的强大扩展功能吧！ 🎉
