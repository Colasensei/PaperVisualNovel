# Paper Visual Novel (千页小说引擎)

一个用C++编写的视觉小说游戏引擎，支持分支剧情、变量系统、结局收集和存档功能

脚本编码要求GB2312

## 功能特性

### 核心功能

- **PGN脚本语言**：自定义的脚本语言，支持剧情控制
- **分支剧情**：支持选择分支和条件跳转
- **变量系统**：完整的变量管理，支持算术运算
- **结局收集**：多结局系统，支持进度统计
- **存档系统**：自动存档/加载功能

### 用户体验

- **打字机效果**：文字逐字显示，支持速度调节
- **颜色输出**：支持多种颜色文本显示
- **快捷键操作**：支持ESC菜单、F12调试终端
- **模糊匹配**：命令输入错误时提供相似建议

### 技术特性

- **模块化设计**：代码结构清晰，易于维护和扩展
- **跨平台兼容**：使用标准C++17，支持Windows系统
- **安全文件操作**：文件类型和大小检查机制
- **条件表达式**：支持复杂条件判断（&&, ||, ==, !=等）

## 项目结构

```
pgn_project/
├── main.cpp              # 主程序入口
├── header.h             # 主头文件，包含所有声明
├── gamestate.cpp/.h     # 游戏状态管理
├── parser.cpp/.h        # PGN脚本解析和执行
├── fileutils.cpp/.h     # 文件操作相关
├── ui.cpp/.h           # 用户界面功能
├── debug.cpp/.h         # 调试终端功能
├── condition.cpp/.h     # 条件表达式解析
└── pgn.cpp             # 核心PGN引擎
```

## PGN脚本语法

### 基本命令

```pgn
# 显示文本
say "你好，世界！" 0.5 blue

# 等待
wait 1000

# 设置变量
set score = 100
set score += 10
set score -= 5

# 随机数
random luck 1 10

# 条件判断
if score > 50 good_end
if score <= 50 bad_end
if flag == 1 && score > 80 secret_end

# 选择分支
choose 2 option1:去图书馆 option2:去操场

option1:
...

option2:
...

# 跳转
jump chapter1

# 显示文件
show image.jpg

# 结局
endname "美好结局"
end
```

### 标签系统

```pgn
# 定义标签
chapter1:
say "第一章开始..."

# 跳转到标签
jump chapter1
```

## 快速开始

### 编译运行

```bash
# 使用msvc编译
# 推荐使用VisualStudio

# 运行程序
./pgn.exe
```

### 创建新游戏

1. 在 `Novel/` 目录下创建游戏文件夹
2. 创建 `.pgn` 脚本文件
3. 可选的 `archive/` 文件夹存放资源文件
4. 可选的 `saves/` 文件夹存放存档

### 示例游戏结构

```
Novel/
└── MyGame/
    ├── MyGame.pgn        # 游戏脚本(脚本名必须与文件夹名一致)
    ├── archive/          # 资源文件
    │   ├── bg.jpg
    │   └── music.mp3
    └── saves/            # 存档文件夹（自动创建）
```

## 颜色代码

| 颜色  | 代码     | 示例                    |
| --- | ------ | --------------------- |
| 黑色  | black  | `say "文本" 0.5 black`  |
| 蓝色  | blue   | `say "文本" 0.5 blue`   |
| 绿色  | green  | `say "文本" 0.5 green`  |
| 青色  | aqua   | `say "文本" 0.5 aqua`   |
| 红色  | red    | `say "文本" 0.5 red`    |
| 紫色  | purple | `say "文本" 0.5 purple` |
| 黄色  | yellow | `say "文本" 0.5 yellow` |
| 白色  | white  | `say "文本" 0.5 white`  |
| 灰色  | gray   | `say "文本" 0.5 gray`   |

## 调试功能

首先，在根目录进入`data.cfg`，修改键值`DevModeEnabled`为1

按 **F12** 键进入调试终端：

```
Debug> help              # 显示帮助
Debug> vars              # 查看所有变量
Debug> set score 100     # 设置变量
Debug> history           # 查看选择历史
Debug> endings           # 查看结局收集
Debug> info              # 查看游戏信息
Debug> goto 50           # 跳转到第50行
Debug> exit              # 退出调试
Debug> log info test     # 输出日志
```

## 存档系统

### 自动存档

- 游戏在退出时自动保存到 `saves/autosave.sav`
- 包含游戏状态、变量、选择历史和结局收集

### 存档格式

```ini
[SAVE_INFO]
script_path=Novel/MyGame/MyGame.pgn
current_line=42
save_time=2024-01-15 14:30:25

[VARIABLES]
score=100
flag=1

[CHOICE_HISTORY]
选择了选项1
选择了选项2

[COLLECTED_ENDINGS]
美好结局
```

## 开发指南

### 扩展新命令

1. 在 `parser.cpp` 的 `executeLine` 函数中添加新命令处理
2. 添加相应的实现逻辑

### 修改UI样式

- 颜色控制：修改 `ui.cpp` 中的 `vnout` 函数
- 进度条：修改 `simpleProgressBar` 函数
- 菜单界面：修改 `Run()` 函数中的显示逻辑

### 添加新功能

1. 创建新的 `.h/.cpp` 文件对
2. 在 `header.h` 中添加声明
3. 在 `main.cpp` 或相关文件中调用

## 系统要求

- **编译器**:  MSVC 2017+（支持C++17）
- **操作系统**: Windows 7+
- **依赖库**: 标准C++库、Windows API

## 故障排除

### 常见问题

1. **编译错误 "filesystem not found"**
   
   - 确保使用 C++17 标准：`-std=c++17`
   - 添加链接选项：`-lstdc++fs`

2. **游戏脚本无法加载**
   
   - 检查文件路径是否正确
   - 确保 `.pgn` 文件使用2312码

3. **存档损坏**
   
   - 删除 `saves/` 文件夹重新生成
   - 检查脚本是否有语法错误

### 调试技巧

- 使用F12调试终端查看变量状态
- 检查 `data.inf` 文件中的结局记录
- 查看控制台错误信息

## 许可证

本项目为开源软件，遵循Apacha2.0许可证。

## 贡献者

- **colaSensei** - 项目创建者和主要开发者

## 致谢

感谢所有使用和贡献本项目的用户！

## 项目状态

- **版本**: Alpha 1.0
- **状态**: 开发中，功能不完整
- **稳定性**: 可能包含未发现的错误和问题
- **兼容性**: 仅在Windows 11环境下测试

## 功能范围

当前版本实现的基础功能包括：

### 已实现功能

1. **PGN脚本解析器**
   
   - 基本的命令解析和执行
   - 变量管理系统
   - 条件表达式支持

2. **游戏引擎核心**
   
   - 文字显示（打字机效果）
   - 选择分支系统
   - 跳转和标签功能

3. **数据管理**
   
   - 基础存档系统
   - 结局收集统计
   - 游戏状态保存

### 已知限制

1. **功能限制**
   
   - 图像显示功能有限
   - 音频支持基础
   - 动画效果不支持
   - 多语言支持未实现

2. **技术限制**
   
   - 仅支持Windows系统
   - 文件大小有限制
   - 内存管理未优化
   - 错误处理不完善

3. **兼容性问题**
   
   - 脚本编码要求GB2312
   - 某些特殊字符可能出错

## 使用条件

### "按现状"提供

本项目按现状提供，不提供任何形式的保证：

1. **不保证功能完整**
   
   - 可能缺少预期功能
   - 可能包含未实现的功能
   - 功能可能随时变更

2. **不保证无错误**
   
   - 可能存在已知bug
   - 可能存在未知bug
   - 可能引起数据丢失

3. **不保证稳定性**
   
   - 可能崩溃或退出
   - 可能产生意外行为
   - 可能不兼容某些系统

### 风险提示

使用本项目可能带来的风险包括：

1. **数据风险**
   
   - 游戏存档可能损坏
   - 游戏进度可能丢失
   - 配置文件可能出错

2. **系统风险**
   
   - 可能占用过多资源
   - 可能产生临时文件
   - 可能影响其他程序

3. **开发风险**
   
   - API可能随时改变
   - 文件格式可能变更
   - 兼容性可能被破坏

## 技术支持

### 支持范围

- 不提供技术支持和维护
- 不保证问题修复时间
- 不承诺功能增强计划

### 问题处理

- bug报告可能不被处理
- 功能请求可能不被考虑
- 文档可能不及时更新

## 分发和使用

### 使用许可

1. **允许**
   
   - 学习和研究用途
   - 非商业个人使用
   - 有限度的修改和分发

2. **限制**
   
   - 不得用于商业用途
   - 不得声称原创作品
   - 不得去除版权信息

### 免责声明

作者和贡献者对以下情况不承担责任：

1. **使用后果**
   
   - 数据丢失或损坏
   - 系统问题或崩溃
   - 任何形式的损失

2. **衍生问题**
   
   - 修改后的问题
   - 集成时的冲突
   - 不当使用的影响

---

**声明**: 本项目以"按现状"基础提供，使用者需自行承担所有风险。

**注意**: 本项目仍在Alpha测试阶段，功能可能发生变化。欢迎提交问题和建议！
